# Detect malware communication using SSL inspection

## Description

Recently updated Zeek network layer signals for MDE with SSL inspection offer new detection and hunting possibilities. As some malware use common, default or re-used certificates, the following query could help detect AsyncRAT, Cobalt Strike, QuasarRAT, Laplas Clipper, DcRAT, VenomRAT, BitRAT and Mythic C2.

### References
- https://techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/enrich-your-advanced-hunting-experience-using-network-layer/ba-p/3794693
- https://sslbl.abuse.ch/ssl-certificates/
- https://embee-research.ghost.io/shodan-censys-queries/
- https://blog.cyphur.com/detecting-leaked-cobalt-strike/?s=03

### Microsoft 365 Defender & Microsoft Sentinel
```
let IssuerContent = dynamic([@"Major Cobalt Strike", @"Laplas.app", @"Pwn3rs"]);
let SubjectContent = dynamic([@"AsyncRAT Server", @"Major Cobalt Strike", @"Quasar Server CA", @"Laplas.app", @"Mythic", @"DcRat", @"VenomRAT", @"BitRAT"]);
let Timeframe = 1d; // Choose the best timeframe for your investigation
DeviceNetworkEvents
| where Timestamp > ago(Timeframe)
| where ActionType == "SslConnectionInspected"
| extend AdditionalFields = todynamic(AdditionalFields)
| extend issuer = tostring(AdditionalFields.issuer), subject = tostring(AdditionalFields.subject), direction = tostring(AdditionalFields.direction)
| where direction == "Out" and not(ipv4_is_private(RemoteIP))
// Define issuer and subject parameters
| where issuer has_any (IssuerContent) or subject has_any (SubjectContent)
| sort by Timestamp desc 
```

### Versioning
| Version       | Date          | Comments                               |
| ------------- |---------------| ---------------------------------------|
| 1.0           | 13/07/2022    | Initial publish                        |
| 1.1           | 18/07/2022    | Query improvement, Cobalt Strike add    |
